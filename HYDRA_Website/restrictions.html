<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Hydra â€“ Restrictions</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons@4.29.0/dist/feather.min.js"></script>
    <link rel="stylesheet" href="assets/style.css">
</head>

<body data-page="restrictions" class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-100 antialiased">
    <div class="flex h-screen">
        <aside id="sidebar"
            class="hidden sm:flex sm:flex-col sm:w-64 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700">
        </aside>
        <div class="flex-1 flex flex-col overflow-hidden">
            <header
                class="flex items-center justify-between px-4 sm:px-6 py-3 border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900">
                <div class="flex items-center space-x-2">
                    <button id="mobile-menu-button"
                        class="sm:hidden focus:outline-none text-gray-700 dark:text-gray-300"><i
                            data-feather="menu"></i></button>
                    <h1 class="text-xl font-semibold">Restrictions</h1>
                </div>
                <div class="flex items-center space-x-2">
                    <button id="theme-toggle"
                        class="p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none text-gray-700 dark:text-gray-300"><i
                            data-feather="sun"></i></button>
                    <button id="logout-btn"
                        class="p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none text-gray-700 dark:text-gray-300"><i
                            data-feather="log-out"></i></button>
                </div>
            </header>
            <main class="flex-1 overflow-y-auto p-4 sm:p-6 space-y-6">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold">Blocked IPs, Hashes & Domains</h3>
                    <button onclick="showAddModal()"
                        class="px-4 py-2 bg-teal-600 text-white rounded hover:bg-teal-700 text-sm flex items-center">
                        <i data-feather="plus" class="w-4 h-4 mr-1"></i> Add Restriction
                    </button>
                </div>

                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow p-4">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700 text-sm">
                            <thead>
                                <tr>
                                    <th class="px-4 py-2 text-left text-gray-500 dark:text-gray-400">ID</th>
                                    <th class="px-4 py-2 text-left text-gray-500 dark:text-gray-400">Type</th>
                                    <th class="px-4 py-2 text-left text-gray-500 dark:text-gray-400">Value</th>
                                    <th class="px-4 py-2 text-left text-gray-500 dark:text-gray-400">Reason</th>
                                    <th class="px-4 py-2 text-left text-gray-500 dark:text-gray-400">Created</th>
                                    <th class="px-4 py-2 text-left text-gray-500 dark:text-gray-400">Action</th>
                                </tr>
                            </thead>
                            <tbody id="restrictions-table" class="divide-y divide-gray-200 dark:divide-gray-700">
                            </tbody>
                        </table>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Add Modal -->
    <div id="add-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-96">
            <h3 class="text-lg font-semibold mb-4">Add Restriction</h3>
            <form id="add-form">
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-1">Type</label>
                    <select id="add-type"
                        class="w-full px-3 py-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded">
                        <option value="ip">IP Address</option>
                        <option value="hash">Hash</option>
                        <option value="domain">Domain</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-1">Value</label>
                    <input type="text" id="add-value"
                        class="w-full px-3 py-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded"
                        placeholder="e.g., 192.168.1.100">
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" onclick="hideAddModal()"
                        class="px-4 py-2 bg-gray-300 dark:bg-gray-600 rounded">Cancel</button>
                    <button type="submit"
                        class="px-4 py-2 bg-teal-600 text-white rounded hover:bg-teal-700">Add</button>
                </div>
            </form>
        </div>
    </div>

    <script src="data/mock-data.js"></script>
    <script src="services/ApiService.js"></script>
    <script src="services/StorageService.js"></script>
    <script src="utils/constants.js"></script>
    <script src="utils/helpers.js"></script>

    <script>
        const BACKEND_URL = 'http://localhost:5000';

        async function loadRestrictions() {
            try {
                const resp = await fetch(`${BACKEND_URL}/api/restrictions`);
                const data = await resp.json();
                renderRestrictions(data.restrictions || []);
            } catch (err) {
                console.error('Failed to load restrictions:', err);
            }
        }

        function renderRestrictions(restrictions) {
            const tbody = document.getElementById('restrictions-table');
            tbody.innerHTML = restrictions.map(r => `
        <tr>
          <td class="px-4 py-2">${r.id}</td>
          <td class="px-4 py-2">
            <span class="px-2 py-1 text-xs rounded ${getTypeClass(r.type)}">${r.type.toUpperCase()}</span>
          </td>
          <td class="px-4 py-2 font-mono text-sm">${r.value}</td>
          <td class="px-4 py-2">${r.reason || '-'}</td>
          <td class="px-4 py-2">${formatTime(r.created_at)}</td>
          <td class="px-4 py-2">
            <button onclick="deleteRestriction(${r.id})" class="px-3 py-1 bg-red-600 text-white rounded text-xs hover:bg-red-700">Delete</button>
          </td>
        </tr>
      `).join('');
        }

        function getTypeClass(type) {
            switch (type) {
                case 'ip': return 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200';
                case 'hash': return 'bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200';
                case 'domain': return 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function formatTime(isoString) {
            if (!isoString) return 'N/A';
            return new Date(isoString).toLocaleDateString();
        }

        function showAddModal() { document.getElementById('add-modal').classList.remove('hidden'); }
        function hideAddModal() { document.getElementById('add-modal').classList.add('hidden'); }

        document.getElementById('add-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const token = localStorage.getItem('authToken');
            if (!token) { alert('Please login'); window.location.href = 'login.html'; return; }

            const type = document.getElementById('add-type').value;
            const value = document.getElementById('add-value').value;

            try {
                const resp = await fetch(`${BACKEND_URL}/api/restrictions`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type, value })
                });

                if (resp.ok) {
                    hideAddModal();
                    loadRestrictions();
                    document.getElementById('add-value').value = '';
                } else {
                    const err = await resp.json();
                    alert(err.error || 'Failed to add');
                }
            } catch (err) { console.error(err); }
        });

        async function deleteRestriction(id) {
            if (!confirm('Delete this restriction?')) return;
            const token = localStorage.getItem('authToken');

            try {
                const resp = await fetch(`${BACKEND_URL}/api/restrictions/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (resp.ok) loadRestrictions();
            } catch (err) { console.error(err); }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Initialize theme and standard UI behaviors
            Helpers.loadPersistedData();
            Helpers.initThemeToggle();
            Helpers.initLogout();
            Helpers.initMobileMenu();

            feather.replace();
            loadRestrictions();
            fetch('partials/sidebar.html?v=' + Date.now()).then(r => r.text()).then(html => {
                document.getElementById('sidebar').innerHTML = html;
                Helpers.highlightActiveNav(); // Add highlight
                feather.replace();
            });
        });
    </script>
</body>

</html>