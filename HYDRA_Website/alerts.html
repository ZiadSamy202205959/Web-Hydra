<!DOCTYPE html>
<html lang="en" class="dark">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Web Hydra â€“ Alerts</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/feather-icons@4.29.0/dist/feather.min.js"></script>
  <link rel="stylesheet" href="assets/style.css">
</head>

<body data-page="alerts" class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-100 antialiased">
  <div class="flex h-screen">
    <aside id="sidebar"
      class="hidden sm:flex sm:flex-col sm:w-64 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700">
    </aside>
    <div class="flex-1 flex flex-col overflow-hidden">
      <header
        class="flex items-center justify-between px-4 sm:px-6 py-3 border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900">
        <div class="flex items-center space-x-2">
          <button id="mobile-menu-button" class="sm:hidden focus:outline-none text-gray-700 dark:text-gray-300"><i
              data-feather="menu"></i></button>
          <h1 class="text-xl font-semibold">Alerts</h1>
        </div>
        <div class="flex items-center space-x-2">
          <button id="theme-toggle"
            class="p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none text-gray-700 dark:text-gray-300"><i
              data-feather="sun"></i></button>
          <button id="logout-btn"
            class="p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none text-gray-700 dark:text-gray-300"><i
              data-feather="log-out"></i></button>
        </div>
      </header>
      <main class="flex-1 overflow-y-auto p-4 sm:p-6 space-y-6">
        <div class="page-header">
          <h3 class="page-title">Security Alerts (Medium - Critical)</h3>
          <div class="flex space-x-2">
            <select id="severity-filter" class="input-field" style="width: auto;">
              <option value="">All Severities</option>
              <option value="Medium">Medium</option>
              <option value="High">High</option>
              <option value="Critical">Critical</option>
            </select>
            <select id="status-filter" class="input-field" style="width: auto;">
              <option value="">All Status</option>
              <option value="open">Open</option>
              <option value="checked">Checked</option>
            </select>
          </div>
        </div>
        <div class="card p-4 animate-fade-in">
          <div class="overflow-x-auto">
            <table class="data-table text-sm">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Severity</th>
                  <th>Source</th>
                  <th>Description</th>
                  <th>Time</th>
                  <th>Status</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="alerts-table"></tbody>
            </table>
          </div>
          <div id="no-alerts" class="hidden empty-state">
            <i data-feather="bell-off"></i>
            <p>No alerts found</p>
          </div>
        </div>
      </main>
    </div>
  </div>

  <script src="data/mock-data.js"></script>
  <script src="services/ApiService.js"></script>
  <script src="services/StorageService.js"></script>
  <script src="utils/constants.js"></script>
  <script src="utils/helpers.js"></script>
  <script src="models/DataModel.js"></script>
  <script src="models/UserModel.js"></script>
  <script src="models/AuthModel.js"></script>

  <script>
    const BACKEND_URL = 'http://localhost:5000';

    async function loadAlerts() {
      const severity = document.getElementById('severity-filter').value;
      const status = document.getElementById('status-filter').value;

      let url = `${BACKEND_URL}/api/alerts?`;
      if (severity) url += `severity=${severity}&`;
      if (status) url += `status=${status}`;

      try {
        const resp = await fetch(url);
        const data = await resp.json();
        renderAlerts(data.alerts || []);
      } catch (err) {
        console.error('Failed to load alerts:', err);
        document.getElementById('no-alerts').classList.remove('hidden');
      }
    }

    function renderAlerts(alerts) {
      const tbody = document.getElementById('alerts-table');
      const noAlerts = document.getElementById('no-alerts');

      if (!alerts.length) {
        tbody.innerHTML = '';
        noAlerts.classList.remove('hidden');
        return;
      }

      noAlerts.classList.add('hidden');
      tbody.innerHTML = alerts.map(a => `
        <tr>
          <td class="px-4 py-2">${a.alert_id}</td>
          <td class="px-4 py-2">
            <span class="px-2 py-1 text-xs rounded ${getSeverityClass(a.severity)}">${a.severity}</span>
          </td>
          <td class="px-4 py-2">${a.source || 'Unknown'}</td>
          <td class="px-4 py-2 max-w-xs truncate">${a.description || a.alert_type}</td>
          <td class="px-4 py-2">${formatTime(a.created_at)}</td>
          <td class="px-4 py-2">
            <span class="px-2 py-1 text-xs rounded ${a.status === 'checked' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">${a.status}</span>
          </td>
          <td class="px-4 py-2">
            ${a.status !== 'checked' ? `<button onclick="markChecked(${a.alert_id})" class="px-3 py-1 bg-teal-600 text-white rounded text-xs hover:bg-teal-700">Mark Checked</button>` : '<span class="text-gray-400">Done</span>'}
          </td>
        </tr>
      `).join('');
    }

    function getSeverityClass(severity) {
      switch (severity) {
        case 'Critical': return 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200';
        case 'High': return 'bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200';
        case 'Medium': return 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200';
        default: return 'bg-gray-100 text-gray-800';
      }
    }

    function formatTime(isoString) {
      if (!isoString) return 'N/A';
      return new Date(isoString).toLocaleString();
    }

    async function markChecked(alertId) {
      const token = localStorage.getItem('authToken');
      if (!token) {
        alert('Please login first');
        window.location.href = 'login.html';
        return;
      }

      try {
        const resp = await fetch(`${BACKEND_URL}/api/alerts/${alertId}/check`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (resp.ok) {
          loadAlerts();
        } else {
          const err = await resp.json();
          alert(err.error || 'Failed to update alert');
        }
      } catch (err) {
        console.error('Failed to mark alert:', err);
      }
    }

    document.getElementById('severity-filter').addEventListener('change', loadAlerts);
    document.getElementById('status-filter').addEventListener('change', loadAlerts);

    document.addEventListener('DOMContentLoaded', () => {
      // Initialize theme and standard UI behaviors
      Helpers.loadPersistedData();
      Helpers.initThemeToggle();
      Helpers.initLogout();
      Helpers.initMobileMenu();

      feather.replace();
      loadAlerts();

      // Sidebar is now handled by Helpers.loadSidebar logic usually, but here we invoke it manually or use the existing fetch
      // Since this page uses inline JS, we'll stick to its existing sidebar fetch but add the helper calls above for theme.
      fetch('partials/sidebar.html?v=' + Date.now())
        .then(r => r.text())
        .then(html => {
          document.getElementById('sidebar').innerHTML = html;
          Helpers.highlightActiveNav(); // Add highlight
          feather.replace();
        });
    });
  </script>
</body>

</html>