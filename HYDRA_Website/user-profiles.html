<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Hydra â€“ User Behavior Profiling</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons@4.29.0/dist/feather.min.js"></script>
    <link rel="stylesheet" href="assets/style.css">
</head>

<body data-page="profiles" class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-100 antialiased">
    <div class="flex h-screen">
        <aside id="sidebar"
            class="hidden sm:flex sm:flex-col sm:w-64 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700">
        </aside>
        <div class="flex-1 flex flex-col overflow-hidden">
            <header
                class="flex items-center justify-between px-4 sm:px-6 py-3 border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900">
                <div class="flex items-center space-x-2">
                    <button id="mobile-menu-button"
                        class="sm:hidden focus:outline-none text-gray-700 dark:text-gray-300"><i
                            data-feather="menu"></i></button>
                    <h1 class="text-xl font-semibold">User Behavior Profiling</h1>
                </div>
                <div class="flex items-center space-x-2">
                    <button id="theme-toggle"
                        class="p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none text-gray-700 dark:text-gray-300"><i
                            data-feather="sun"></i></button>
                    <button id="logout-btn"
                        class="p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none text-gray-700 dark:text-gray-300"><i
                            data-feather="log-out"></i></button>
                </div>
            </header>
            <main class="flex-1 overflow-y-auto p-4 sm:p-6 space-y-6">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold">Suspicious User Profiles</h3>
                    <button onclick="showModal()"
                        class="px-4 py-2 bg-teal-600 text-white rounded hover:bg-teal-700 text-sm flex items-center">
                        <i data-feather="user-plus" class="w-4 h-4 mr-1"></i> Add Profile
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="profiles-grid"></div>
            </main>
        </div>
    </div>

    <!-- Modal -->
    <div id="profile-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-[500px] max-h-[90vh] overflow-y-auto">
            <h3 id="modal-title" class="text-lg font-semibold mb-4">Add Suspicious Profile</h3>
            <form id="profile-form">
                <input type="hidden" id="profile-id">
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Username</label>
                        <input type="text" id="sus-username"
                            class="w-full px-3 py-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded"
                            required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">PC Number</label>
                        <input type="text" id="pc-number"
                            class="w-full px-3 py-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">IP Address</label>
                        <input type="text" id="ip-address"
                            class="w-full px-3 py-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">MAC Address</label>
                        <input type="text" id="mac-address"
                            class="w-full px-3 py-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded"
                            placeholder="AA:BB:CC:DD:EE:FF">
                    </div>
                    <div class="col-span-2">
                        <label class="block text-sm font-medium mb-1">Session Cookie</label>
                        <input type="text" id="session-cookie"
                            class="w-full px-3 py-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded font-mono text-sm">
                    </div>
                    <div class="col-span-2">
                        <label class="block text-sm font-medium mb-1">Suspicion Level</label>
                        <select id="suspicion-level"
                            class="w-full px-3 py-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded">
                            <option value="Low">Low</option>
                            <option value="Medium">Medium</option>
                            <option value="High">High</option>
                            <option value="Critical">Critical</option>
                        </select>
                    </div>
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" onclick="hideModal()"
                        class="px-4 py-2 bg-gray-300 dark:bg-gray-600 rounded">Cancel</button>
                    <button type="submit"
                        class="px-4 py-2 bg-teal-600 text-white rounded hover:bg-teal-700">Save</button>
                </div>
            </form>
        </div>
    </div>

    <script src="services/StorageService.js"></script>
    <script src="utils/helpers.js"></script>
    <script>
        const BACKEND_URL = 'http://localhost:5000';
        let editingId = null;

        async function loadProfiles() {
            try {
                const resp = await fetch(`${BACKEND_URL}/api/profiles`);
                const data = await resp.json();
                renderProfiles(data.profiles || []);
            } catch (err) { console.error(err); }
        }

        function renderProfiles(profiles) {
            const grid = document.getElementById('profiles-grid');
            if (!profiles.length) {
                grid.innerHTML = '<p class="col-span-3 text-center text-gray-500 py-8">No suspicious profiles found</p>';
                return;
            }

            grid.innerHTML = profiles.map(p => `
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow p-4">
          <div class="flex items-center justify-between mb-3">
            <h4 class="font-semibold">${p.sus_username}</h4>
            <span class="px-2 py-1 text-xs rounded ${getSuspicionClass(p.suspicion_level)}">${p.suspicion_level}</span>
          </div>
          <div class="text-sm space-y-1 text-gray-600 dark:text-gray-400">
            <p><strong>PC:</strong> ${p.pc_number || 'N/A'}</p>
            <p><strong>IP:</strong> ${p.ip_address || 'N/A'}</p>
            <p><strong>MAC:</strong> ${p.mac_address || 'N/A'}</p>
            <p class="truncate"><strong>Cookie:</strong> ${p.session_cookie || 'N/A'}</p>
            <p><strong>Added:</strong> ${new Date(p.created_at).toLocaleDateString()}</p>
          </div>
          <div class="flex space-x-2 mt-4">
            <button onclick='editProfile(${JSON.stringify(p)})' class="flex-1 px-3 py-1 bg-blue-600 text-white rounded text-xs">Edit</button>
            <button onclick="deleteProfile(${p.sus_user_id})" class="flex-1 px-3 py-1 bg-red-600 text-white rounded text-xs">Delete</button>
          </div>
        </div>
      `).join('');
        }

        function getSuspicionClass(level) {
            switch (level) {
                case 'Critical': return 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200';
                case 'High': return 'bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200';
                case 'Medium': return 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200';
                default: return 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200';
            }
        }

        function showModal() {
            editingId = null;
            document.getElementById('modal-title').textContent = 'Add Suspicious Profile';
            document.getElementById('profile-form').reset();
            document.getElementById('profile-modal').classList.remove('hidden');
        }

        function hideModal() { document.getElementById('profile-modal').classList.add('hidden'); }

        function editProfile(p) {
            editingId = p.sus_user_id;
            document.getElementById('modal-title').textContent = 'Edit Profile';
            document.getElementById('profile-id').value = p.sus_user_id;
            document.getElementById('sus-username').value = p.sus_username;
            document.getElementById('pc-number').value = p.pc_number || '';
            document.getElementById('ip-address').value = p.ip_address || '';
            document.getElementById('mac-address').value = p.mac_address || '';
            document.getElementById('session-cookie').value = p.session_cookie || '';
            document.getElementById('suspicion-level').value = p.suspicion_level;
            document.getElementById('profile-modal').classList.remove('hidden');
        }

        document.getElementById('profile-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const token = localStorage.getItem('authToken');
            if (!token) { alert('Please login'); return; }

            const payload = {
                sus_username: document.getElementById('sus-username').value,
                pc_number: document.getElementById('pc-number').value,
                ip_address: document.getElementById('ip-address').value,
                mac_address: document.getElementById('mac-address').value,
                session_cookie: document.getElementById('session-cookie').value,
                suspicion_level: document.getElementById('suspicion-level').value
            };

            const url = editingId ? `${BACKEND_URL}/api/profiles/${editingId}` : `${BACKEND_URL}/api/profiles`;
            const method = editingId ? 'PUT' : 'POST';

            try {
                const resp = await fetch(url, {
                    method, headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (resp.ok) { hideModal(); loadProfiles(); }
                else { const err = await resp.json(); alert(err.error); }
            } catch (err) { console.error(err); }
        });

        async function deleteProfile(id) {
            if (!confirm('Delete this profile?')) return;
            const token = localStorage.getItem('authToken');
            try {
                await fetch(`${BACKEND_URL}/api/profiles/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } });
                loadProfiles();
            } catch (err) { console.error(err); }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Initialize theme and standard UI behaviors
            Helpers.loadPersistedData();
            Helpers.initThemeToggle();
            Helpers.initLogout();
            Helpers.initMobileMenu();

            feather.replace();
            loadProfiles();
            fetch('partials/sidebar.html?v=' + Date.now()).then(r => r.text()).then(html => { document.getElementById('sidebar').innerHTML = html; Helpers.highlightActiveNav(); feather.replace(); });
        });
    </script>
</body>

</html>